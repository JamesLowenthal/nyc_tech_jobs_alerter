name: HCP Terraform â€“ Speculative Plan

on:
  workflow_dispatch:
  push:
    branches:
      - main

env:
  TF_CLOUD_ORGANIZATION: NYCJobsDataAlerter
  TF_API_TOKEN: ${{ secrets.TF_API_TOKEN }}
  TF_WORKSPACE: nyc_tech_jobs_alerter
  CONFIG_DIRECTORY: .

jobs:
  terraform-cloud-speculative-run:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - uses: hashicorp/tfc-workflows-github/actions/upload-configuration@v1.3.2
        id: upload
        with:
          workspace: ${{ env.TF_WORKSPACE }}
          directory: ${{ env.CONFIG_DIRECTORY }}
          speculative: true

      - uses: hashicorp/tfc-workflows-github/actions/create-run@v1.3.2
        id: run
        with:
            workspace: ${{ env.TF_WORKSPACE }}
            configuration_version: ${{ steps.upload.outputs.configuration_version_id }}
            plan_only: true
        continue-on-error: true

      - uses: hashicorp/tfc-workflows-github/actions/plan-output@v1.3.2
        id: plan-output
        with:
          plan: ${{ steps.run.outputs.plan_id }}

  terraform-cloud-apply:
    needs: [terraform-cloud-speculative-run]
    runs-on: ubuntu-latest
    environment:
      name: apply
    steps:
      - uses: actions/checkout@v4
    
      - uses: hashicorp/tfc-workflows-github/actions/upload-configuration@v1.3.2
        id: upload
        with:
          workspace: ${{ env.TF_WORKSPACE }}
          directory: ${{ env.CONFIG_DIRECTORY }}
    
      - uses: hashicorp/tfc-workflows-github/actions/create-run@v1.3.2
        id: run
        with:
          workspace: ${{ env.TF_WORKSPACE }}
          configuration_version: ${{ steps.upload.outputs.configuration_version_id }}
          plan_only: false
    
      - name: Wait for run to reach "planned"
        uses: hashicorp/tfc-workflows-github/actions/wait-for-run@v1.3.2
        id: wait
        with:
          run: ${{ steps.run.outputs.run_id }}
    
      # Now that the plan is ready, apply it
      - name: Apply
        if: ${{ steps.wait.outputs.status == 'planned' }}
        uses: hashicorp/tfc-workflows-github/actions/apply-run@v1.3.2
        with:
          run: ${{ steps.run.outputs.run_id }}
         